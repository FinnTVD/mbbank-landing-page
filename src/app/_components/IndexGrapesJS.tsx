/* eslint-disable @typescript-eslint/no-explicit-any */
/* eslint-disable @typescript-eslint/no-unused-vars */
"use client";

import { useEffect, useRef, useState } from "react";
import grapesjs from "grapesjs";
import "@/modules/grapesjs/dist/css/grapes.min.css";
import "@/modules/grapesjs-template-manager/dist/grapesjs-template-manager.min.css";

// Import c√°c plugin mi·ªÖn ph√≠
import grapesjsPresetWebpage from "grapesjs-preset-webpage";
import grapesjsBlocksBasic from "grapesjs-blocks-basic";
import grapesjsPluginForms from "grapesjs-plugin-forms";
import grapesjsPluginExport from "grapesjs-plugin-export";
import grapesjsComponentCountdown from "grapesjs-component-countdown";
import grapesjsNavbar from "grapesjs-navbar";
import grapesjsStyleBg from "grapesjs-style-bg";
import grapesjsTabs from "grapesjs-tabs";
import grapesjsTooltip from "grapesjs-tooltip";
import grapesjsCustomCode from "grapesjs-custom-code";
import grapesjsTouch from "grapesjs-touch";
import grapesjsParserPostcss from "grapesjs-parser-postcss";
import grapesjsPluginCkeditor from "grapesjs-plugin-ckeditor";
import grapesjsTemplateManager from "grapesjs-template-manager";
// import grapesjsSwiperSlider from "grapesjs-swiper-slider";
// import grapesjsBlocksBootstrap4 from "grapesjs-blocks-bootstrap4";
// Import plugin Destack v·ª´a t·∫°o
import pluginCustom from "./plugin-custom";
import swiperCustom from "@/app/_components/plugins/swiper"; // plugin
import templatesPlugin from "./templates-plugin";

// ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu cho b·∫£n l∆∞u
interface SavedVersion {
  id: string;
  name: string;
  date: string;
  html: string;
  css: string;
}

export default function IndexGrapesJS() {
  const editorRef = useRef<HTMLDivElement>(null);
  const [editor, setEditor] = useState<any>(null);
  const [savedVersions, setSavedVersions] = useState<SavedVersion[]>([]);
  const [showSavedList, setShowSavedList] = useState(false);
  const [versionName, setVersionName] = useState("");

  useEffect(() => {
    // Kh√¥i ph·ª•c danh s√°ch c√°c b·∫£n l∆∞u t·ª´ localStorage khi component ƒë∆∞·ª£c mount
    const savedData = localStorage.getItem("mbbank-builder-versions");
    // üõ†Ô∏è N·∫øu mu·ªën reset localStorage l·∫ßn ƒë·∫ßu ti√™n
    // localStorage.removeItem("mbbank-builder-versions");
    if (savedData) {
      setSavedVersions(JSON.parse(savedData));
    }

    if (editorRef.current) {
      const editorInstance = grapesjs.init({
        container: editorRef.current,
        height: "100vh",
        width: "auto",
        fromElement: true,
        // pageManager: true,
        storageManager: {
          autoload: false, // Th√™m d√≤ng n√†y ƒë·ªÉ tr√°nh t·ª± ƒë·ªông load t·ª´ storage
          type: "indexeddb",
        },
        plugins: [
          // plugins custom
          pluginCustom,
          swiperCustom,
          // grapesjsBlocksBootstrap4,
          // ["grapesjs-swiper-slider"],
          // grapesjsSwiperSlider,
          // plugins system
          grapesjsPresetWebpage,
          grapesjsBlocksBasic,
          grapesjsPluginForms,
          grapesjsPluginExport,
          grapesjsComponentCountdown,
          grapesjsNavbar,
          grapesjsStyleBg,
          grapesjsTabs,
          grapesjsTooltip,
          grapesjsCustomCode,
          grapesjsTouch,
          grapesjsParserPostcss,
          grapesjsPluginCkeditor,
          // grapesjsTemplateManager,
          templatesPlugin,
        ],
        pluginsOpts: {
          // plugins custom
          pluginCustom: {},
          swiperCustom: {},
          grapesjsBlocksBootstrap4: {
            // blocks: {
            //   // ...
            // },
            // blockCategories: {
            //   // ...
            // },
            // labels: {
            //   // ...
            // },
          },
          // "grapesjs-swiper-slider": {
          //   // options
          // },
          // grapesjsSwiperSlider: {},
          // plugins system
          grapesjsPresetWebpage: {},
          grapesjsBlocksBasic: {},
          grapesjsPluginForms: {},
          grapesjsPluginExport: {},
          grapesjsComponentCountdown: {},
          grapesjsNavbar: {},
          grapesjsStyleBg: {},
          grapesjsTabs: {},
          grapesjsTooltip: {},
          grapesjsCustomCode: {},
          grapesjsTouch: {},
          grapesjsParserPostcss: {},
          grapesjsPluginCkeditor: {},
          // grapesjsTemplateManager: {
          //   // C·∫•u h√¨nh templates
          //   templates: [
          //     {
          //       id: "template1",
          //       name: "Trang ch·ªß MB Bank",
          //       category: "Trang ch·ªß",
          //       thumbnail: "/mbbank/templates/template1.jpg", // ƒê∆∞·ªùng d·∫´n ƒë·∫øn ·∫£nh thumbnail
          //       template: {
          //         html: `
          //           <div class="header">
          //             <div class="logo">
          //               <img src="/mbbank/Logo_MB_new.png" alt="MB Bank Logo" />
          //             </div>
          //             <div class="nav">
          //               <a href="#">Trang ch·ªß</a>
          //               <a href="#">D·ªãch v·ª•</a>
          //               <a href="#">Li√™n h·ªá</a>
          //             </div>
          //           </div>
          //           <div class="hero">
          //             <h1>Ng√¢n h√†ng MB - ƒê·ªìng h√†nh c√πng th√†nh c√¥ng</h1>
          //             <p>Gi·∫£i ph√°p t√†i ch√≠nh to√†n di·ªán cho c√° nh√¢n v√† doanh nghi·ªáp</p>
          //             <button>T√¨m hi·ªÉu th√™m</button>
          //           </div>
          //         `,
          //         css: `
          //         .header {
          //           display: flex;
          //           justify-content: space-between;
          //           padding: 20px;
          //           background-color: #fff;
          //         }
          //         .logo img {
          //           height: 40px;
          //         }
          //         .nav {
          //           display: flex;
          //           gap: 20px;
          //         }
          //         .nav a {
          //           text-decoration: none;
          //           color: #333;
          //         }
          //         .hero {
          //           text-align: center;
          //           padding: 100px 20px;
          //           background-color: #f5f5f5;
          //         }
          //         .hero h1 {
          //           font-size: 36px;
          //           margin-bottom: 20px;
          //         }
          //         .hero p {
          //           font-size: 18px;
          //           margin-bottom: 30px;
          //         }
          //         .hero button {
          //           padding: 12px 24px;
          //           background-color: #1e88e5;
          //           color: #fff;
          //           border: none;
          //           border-radius: 4px;
          //           cursor: pointer;
          //         }
          //       `,
          //       },
          //     },
          //   ],

          //   // C·∫•u h√¨nh l∆∞u tr·ªØ
          //   storage: "local", // 'local', 'remote', ho·∫∑c 'indexeddb'
          //   storageKey: "mbbank-templates", // Key ƒë·ªÉ l∆∞u v√†o localStorage

          //   // C√°c t√πy ch·ªçn kh√°c
          //   modalTitle: "Ch·ªçn m·∫´u trang MB Bank",
          //   importBtnText: "S·ª≠ d·ª•ng m·∫´u n√†y",
          //   addBtnText: "Th√™m m·∫´u m·ªõi",
          //   editBtnText: "Ch·ªânh s·ª≠a",
          //   deleteBtnText: "X√≥a",

          //   // C√°c callback
          //   onSelect: (template: any) => {
          //     console.log("ƒê√£ ch·ªçn template:", template);
          //   },
          //   onAdd: (template: any) => {
          //     console.log("ƒê√£ th√™m template m·ªõi:", template);
          //   },
          //   onEdit: (template: any) => {
          //     console.log("ƒê√£ ch·ªânh s·ª≠a template:", template);
          //   },
          //   onDelete: (template: any) => {
          //     console.log("ƒê√£ x√≥a template:", template);
          //   },
          // },
        },
      });

      // üßπ X√≥a s·∫°ch template
      editorInstance.setComponents("");
      editorInstance.setStyle("");

      setEditor(editorInstance);

      // T·∫°o command ƒë·ªÉ hi·ªÉn th·ªã dialog l∆∞u phi√™n b·∫£n
      editorInstance.Commands.add("show-save-dialog", {
        run: function () {
          setShowSavedList(false);
          document.getElementById("save-dialog")?.classList.remove("hidden");
        },
        stop: function () {
          document.getElementById("save-dialog")?.classList.add("hidden");
        },
      });

      // T·∫°o command ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch phi√™n b·∫£n
      editorInstance.Commands.add("show-versions-list", {
        run: function () {
          setShowSavedList(true);
          document.getElementById("versions-list")?.classList.remove("hidden");
        },
        stop: function () {
          document.getElementById("versions-list")?.classList.add("hidden");
        },
      });

      // Running commands from panels
      const pn = editorInstance.Panels;
      const panelOpts = pn.addPanel({
        id: "options",
      });
      // Th√™m n√∫t template manager v√†o thanh c√¥ng c·ª•
      panelOpts.get("buttons").add([
        {
          attributes: {
            title: "Ch·ªçn m·∫´u trang",
          },
          className: "fa fa-file-o",
          command: "open-templates", //Open modal
          id: "open-templates",
        },
      ]);

      // Th√™m n√∫t l∆∞u v√†o thanh c√¥ng c·ª•
      pn.addButton("options", {
        id: "save-version",
        className: "fa fa-floppy-o",
        command: "show-save-dialog",
        attributes: { title: "L∆∞u phi√™n b·∫£n" },
      });

      // Th√™m n√∫t xem danh s√°ch phi√™n b·∫£n ƒë√£ l∆∞u
      pn.addButton("options", {
        id: "view-versions",
        className: "fa fa-list",
        command: "show-versions-list",
        attributes: { title: "Xem danh s√°ch phi√™n b·∫£n" },
      });

      // üõ†Ô∏è Th√™m logo v√†o gi·ªØa thanh c√¥ng c·ª•
      setTimeout(() => {
        const panelButtons = document.querySelector(
          ".gjs-pn-panels .gjs-pn-buttons"
        );
        if (panelButtons && !panelButtons.querySelector(".custom-logo")) {
          const logo = document.createElement("img");
          logo.src = "/mbbank/Logo_MB_new.png"; // üîπ ƒê∆∞·ªùng d·∫´n logo c·ªßa b·∫°n
          logo.alt = "Logo";
          logo.className = "custom-logo"; // üî• G√°n class ƒë·ªÉ sau n√†y d·ªÖ ki·ªÉm tra
          logo.style.height = "40px";
          logo.style.margin = "0 auto";

          // Th√™m logo v√†o gi·ªØa c√°c n√∫t
          panelButtons.insertBefore(
            logo,
            panelButtons.children[Math.floor(panelButtons.children.length / 2)]
          );
        }
      }, 500);
      // ƒê·ª£i GrapesJS load xong tr∆∞·ªõc khi ch√®n logo
    }
  }, []);

  // H√†m l∆∞u phi√™n b·∫£n hi·ªán t·∫°i
  const saveCurrentVersion = () => {
    if (!editor || !versionName.trim()) return;

    const html = editor.getHtml();
    const css = editor.getCss();
    const newVersion: SavedVersion = {
      id: Date.now().toString(),
      name: versionName,
      date: new Date().toLocaleString("vi-VN"),
      html,
      css,
    };

    const updatedVersions = [...savedVersions, newVersion];
    setSavedVersions(updatedVersions);
    localStorage.setItem(
      "mbbank-builder-versions",
      JSON.stringify(updatedVersions)
    );

    setVersionName("");
    document.getElementById("save-dialog")?.classList.add("hidden");
  };

  // H√†m t·∫£i phi√™n b·∫£n ƒë√£ l∆∞u
  const loadVersion = (version: SavedVersion) => {
    if (!editor) return;

    editor.setComponents(version.html);
    editor.setStyle(version.css);

    document.getElementById("versions-list")?.classList.add("hidden");
  };

  // H√†m x√≥a phi√™n b·∫£n ƒë√£ l∆∞u
  const deleteVersion = (id: string) => {
    const updatedVersions = savedVersions.filter((v) => v.id !== id);
    setSavedVersions(updatedVersions);
    localStorage.setItem(
      "mbbank-builder-versions",
      JSON.stringify(updatedVersions)
    );
  };

  return (
    <main className="flex h-screen relative">
      <div
        className="flex-1 w-full h-full overflow-hidden"
        ref={editorRef}
      ></div>

      {/* Dialog l∆∞u phi√™n b·∫£n */}
      <div
        id="save-dialog"
        className="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-lg z-50 w-96"
      >
        <h2 className="text-xl font-bold mb-4">L∆∞u phi√™n b·∫£n</h2>
        <input
          type="text"
          value={versionName}
          onChange={(e) => setVersionName(e.target.value)}
          placeholder="Nh·∫≠p t√™n phi√™n b·∫£n"
          className="w-full p-2 border border-gray-300 rounded mb-4"
        />
        <div className="flex justify-end gap-2">
          <button
            onClick={() =>
              document.getElementById("save-dialog")?.classList.add("hidden")
            }
            className="px-4 py-2 bg-gray-200 rounded"
          >
            H·ªßy
          </button>
          <button
            onClick={saveCurrentVersion}
            className="px-4 py-2 bg-blue-500 text-white rounded"
            disabled={!versionName.trim()}
          >
            L∆∞u
          </button>
        </div>
      </div>

      {/* Danh s√°ch phi√™n b·∫£n ƒë√£ l∆∞u */}
      <div
        id="versions-list"
        className="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-lg z-50 w-[500px] max-h-[80vh] overflow-auto"
      >
        <h2 className="text-xl font-bold mb-4">Danh s√°ch phi√™n b·∫£n ƒë√£ l∆∞u</h2>
        {savedVersions.length === 0 ? (
          <p className="text-gray-500">Ch∆∞a c√≥ phi√™n b·∫£n n√†o ƒë∆∞·ª£c l∆∞u</p>
        ) : (
          <ul className="divide-y divide-gray-200">
            {savedVersions.map((version) => (
              <li key={version.id} className="py-3">
                <div className="flex justify-between items-center">
                  <div>
                    <h3 className="font-medium">{version.name}</h3>
                    <p className="text-sm text-gray-500">{version.date}</p>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => loadVersion(version)}
                      className="px-3 py-1 bg-blue-500 text-white text-sm rounded"
                    >
                      Xem
                    </button>
                    <button
                      onClick={() => deleteVersion(version.id)}
                      className="px-3 py-1 bg-red-500 text-white text-sm rounded"
                    >
                      X√≥a
                    </button>
                  </div>
                </div>
              </li>
            ))}
          </ul>
        )}
        <div className="mt-4 flex justify-end">
          <button
            onClick={() =>
              document.getElementById("versions-list")?.classList.add("hidden")
            }
            className="px-4 py-2 bg-gray-200 rounded"
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </main>
  );
}
